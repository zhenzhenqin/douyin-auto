<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æŠ–éŸ³ç«èŠ±ç¾¤å‘åŠ©æ‰‹ - æ§åˆ¶å°</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; max-width: 600px; margin: 30px auto; padding: 20px; background: #f5f5f5; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 12px; display: flex; justify-content: space-between; align-items: center;}

        /* åˆ—è¡¨æ ·å¼ */
        .friend-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
        .friend-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; background: #fff; }
        .friend-item:last-child { border-bottom: none; }
        .friend-item span { font-weight: 500; color: #333; }
        .del-btn { background: #ff4d4f; color: white; padding: 5px 10px; font-size: 12px; border-radius: 4px; margin: 0; }

        /* è¾“å…¥ç»„ */
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        input[type="time"] { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }

        /* æŒ‰é’®é€šç”¨ */
        button { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.2s; color: white; }
        button:active { transform: scale(0.98); }
        .btn-add { background: #1677ff; }
        .btn-save { background: #fe2c55; width: 100%; margin-top: 10px; font-size: 16px; font-weight: bold;}
        .btn-login { background: #333; margin-right: 10px;}
        .btn-run { background: #faad14; color: #fff; }
        .btn-schedule { background: #52c41a; width: 100%; margin-top: 10px;}

        #log { background: #1e1e1e; color: #4ade80; padding: 15px; border-radius: 8px; height: 180px; overflow-y: scroll; font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.5; white-space: pre-wrap; }
        .badge { background: #eee; color: #666; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ‘¥ å¥½å‹ç®¡ç† <span class="badge" id="count">0äºº</span></h2>

    <div class="input-group">
        <input type="text" id="newFriendName" placeholder="è¾“å…¥å¥½å‹æ˜µç§° (å¦‚: å§å”§å§å”§)">
        <button class="btn-add" onclick="addFriend()">æ·»åŠ </button>
    </div>

    <ul class="friend-list" id="friendList">
        <li class="friend-item" style="justify-content: center; color: #999;">æš‚æ— å¥½å‹ï¼Œè¯·æ·»åŠ </li>
    </ul>
</div>

<div class="card">
    <h2>â° å®šæ—¶è®¾ç½®</h2>
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <label>æ¯å¤©è¿è¡Œæ—¶é—´ï¼š</label>
        <input type="time" id="scheduleTime" value="08:00">
    </div>
    <button class="btn-save" onclick="saveConfig()">ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®</button>
</div>

<div class="card">
    <h2>ğŸš€ æ§åˆ¶ä¸­å¿ƒ</h2>
    <div style="margin-bottom: 15px;">
        <button class="btn-login" onclick="runLogin()">æ‰«ç ç™»å½•</button>
        <button class="btn-run" onclick="runNow()">ç«‹å³ç¾¤å‘ä¸€æ¬¡</button>
    </div>
    <div style="border-top: 1px solid #eee; padding-top: 15px;">
        <button class="btn-schedule" onclick="setSchedule()">âœ… æ›´æ–°ç³»ç»Ÿå®šæ—¶ä»»åŠ¡</button>
        <div style="font-size: 12px; color: #888; margin-top: 5px; text-align: center;">æ›´æ–°ä»»åŠ¡å‰è¯·å…ˆç‚¹å‡»â€œä¿å­˜é…ç½®â€</div>
    </div>
</div>

<div id="log">ç­‰å¾…æ“ä½œ...</div>

<script>
    let friends = [];
    const logDiv = document.getElementById('log');

    function log(msg) {
        const time = new Date().toLocaleTimeString();
        logDiv.innerText = `[${time}] ${msg}\n` + logDiv.innerText;
    }

    // 1. åˆå§‹åŒ–åŠ è½½
    fetch('/api/config').then(r => r.json()).then(data => {
        // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šå¦‚æœ data.friendName å­˜åœ¨ä½† data.friends ä¸å­˜åœ¨
        if (!data.friends && data.friendName) {
            friends = [{ name: data.friendName }];
        } else {
            friends = data.friends || [];
        }
        document.getElementById('scheduleTime').value = data.scheduleTime || '08:00';
        renderList();
    });

    // 2. æ¸²æŸ“åˆ—è¡¨
    function renderList() {
        const list = document.getElementById('friendList');
        const count = document.getElementById('count');
        list.innerHTML = '';
        count.innerText = `${friends.length}äºº`;

        if (friends.length === 0) {
            list.innerHTML = '<li class="friend-item" style="justify-content: center; color: #999;">æš‚æ— å¥½å‹ï¼Œè¯·æ·»åŠ </li>';
            return;
        }

        friends.forEach((f, index) => {
            const li = document.createElement('li');
            li.className = 'friend-item';
            li.innerHTML = `
                    <span>${index + 1}. ${f.name}</span>
                    <button class="del-btn" onclick="removeFriend(${index})">åˆ é™¤</button>
                `;
            list.appendChild(li);
        });
    }

    // 3. æ·»åŠ å¥½å‹
    function addFriend() {
        const input = document.getElementById('newFriendName');
        const name = input.value.trim();
        if (!name) return alert('åå­—ä¸èƒ½ä¸ºç©º');

        // æŸ¥é‡
        if (friends.some(f => f.name === name)) return alert('è¿™ä¸ªå¥½å‹å·²ç»åœ¨åˆ—è¡¨é‡Œäº†');

        friends.push({ name: name });
        input.value = '';
        renderList();
    }

    // 4. åˆ é™¤å¥½å‹
    function removeFriend(index) {
        friends.splice(index, 1);
        renderList();
    }

    // 5. ä¿å­˜é…ç½®
    async function saveConfig() {
        const time = document.getElementById('scheduleTime').value;
        if (friends.length === 0) return alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå¥½å‹ï¼');

        await fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ friends: friends, scheduleTime: time })
        });
        log(`é…ç½®å·²ä¿å­˜ï¼šå…± ${friends.length} ä½å¥½å‹ï¼Œæ—¶é—´ ${time}`);
        alert('ä¿å­˜æˆåŠŸï¼');
    }

    async function runLogin() {
        log('å¯åŠ¨ç™»å½•çª—å£...');
        const res = await fetch('/api/login', { method: 'POST' });
        log(await res.text());
    }

    async function runNow() {
        log('æ­£åœ¨åå°å¯åŠ¨ç¾¤å‘ä»»åŠ¡...');
        const res = await fetch('/api/run', { method: 'POST' });
        if(res.ok) log('ä»»åŠ¡å®Œæˆï¼Œè¯·æŸ¥çœ‹æœ¬åœ°æ—¥å¿—');
        else log('å¯åŠ¨å¤±è´¥');
    }

    async function setSchedule() {
        await saveConfig(); // å¼ºåˆ¶å…ˆä¿å­˜
        log('æ­£åœ¨æ›´æ–°ç³»ç»Ÿä»»åŠ¡...');
        const res = await fetch('/api/schedule', { method: 'POST' });
        const data = await res.json();
        alert(data.msg || data.error);
        log(data.msg || data.details);
    }
</script>
</body>
</html>